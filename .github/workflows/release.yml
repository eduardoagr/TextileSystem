name: Smart MAUI Auto Release

on:
  push:
    branches:
      - master  # Change to 'main' if your default branch is main

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      # --------------------------
      # Checkout code
      # --------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for semantic versioning

      # --------------------------
      # Setup .NET 10
      # --------------------------
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # --------------------------
      # Install MAUI workloads
      # --------------------------
      - name: Install MAUI
        run: dotnet workload install maui

      # --------------------------
      # Get latest tag safely
      # --------------------------
      - name: Get latest tag
        id: gettag
        shell: pwsh
        run: |
          try {
              $tag = git describe --tags --abbrev=0
          } catch {
              $tag = "v0.0.0"
          }
          echo "CURRENT_TAG=$tag" >> $env:GITHUB_ENV
          Write-Host "Latest tag: $tag"

      # --------------------------
      # Calculate next semantic version
      # --------------------------
      - name: Calculate next version
        id: version
        shell: pwsh
        run: |
          $current = $env:CURRENT_TAG.TrimStart("v")
          $parts = $current.Split(".")
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]

          # Get commit messages since last tag
          $messages = git log $env:CURRENT_TAG..HEAD --pretty=%B

          if ($messages -match "BREAKING:") {
            $major++
            $minor = 0
            $patch = 0
          }
          elseif ($messages -match "feat:") {
            $minor++
            $patch = 0
          }
          else {
            $patch++
          }

          $newVersion = "v$major.$minor.$patch"
          echo "VERSION=$newVersion" >> $env:GITHUB_ENV
          Write-Host "Calculated version: $newVersion"

      # --------------------------
      # Restore dependencies
      # --------------------------
      - name: Restore
        run: dotnet restore

      # --------------------------
      # Build Windows
      # --------------------------
      - name: Publish Windows
        run: dotnet publish -c Release -f net10.0-windows10.0.19041.0 -p:WindowsPackageType=None

      # --------------------------
      # Build Android
      # --------------------------
      - name: Publish Android
        run: dotnet publish -c Release -f net10.0-android -p:AndroidPackageFormat=apk

      # --------------------------
      # Zip Windows build (only if folder exists)
      # --------------------------
      - name: Zip Windows build
        shell: pwsh
        run: |
          $winPath = "bin/Release/net10.0-windows10.0.19041.0/publish"
          $winZip = "TextileSystem-Windows-$env:VERSION.zip"
          if (Test-Path $winPath) {
              Compress-Archive -Path "$winPath\*" -DestinationPath $winZip
              echo "Windows zip created: $winZip"
              echo "WIN_ZIP=$winZip" >> $env:GITHUB_ENV
          } else {
              Write-Host "Windows publish folder not found. Skipping zip."
          }

      # --------------------------
      # Zip Android build (only if folder exists)
      # --------------------------
      - name: Zip Android build
        shell: pwsh
        run: |
          $androidPath = "bin/Release/net10.0-android/android-arm64/publish"
          $androidZip = "TextileSystem-Android-$env:VERSION.zip"
          if (Test-Path $androidPath) {
              Compress-Archive -Path "$androidPath\*" -DestinationPath $androidZip
              echo "Android zip created: $androidZip"
              echo "ANDROID_ZIP=$androidZip" >> $env:GITHUB_ENV
          } else {
              Write-Host "Android publish folder not found. Skipping zip."
          }

      # --------------------------
      # Create GitHub Release (only if zips exist)
      # --------------------------
      - name: Create GitHub Release
        if: env.WIN_ZIP != '' || env.ANDROID_ZIP != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          files: ${{ env.WIN_ZIP }},${{ env.ANDROID_ZIP }}
